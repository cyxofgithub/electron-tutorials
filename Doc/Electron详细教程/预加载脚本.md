## å­¦ä¹ ç›®æ ‡

åœ¨è¿™éƒ¨åˆ†æ•™ç¨‹ä¸­ï¼Œä½ å°†å­¦ä¹ ä»€ä¹ˆæ˜¯é¢„åŠ è½½è„šæœ¬ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨é¢„åŠ è½½è„šæœ¬å°†ç‰¹æƒ API å®‰å…¨åœ°æš´éœ²åœ¨å‘ˆç°å™¨è¿›ç¨‹ä¸­ã€‚ä½ è¿˜å°†å­¦ä¹ å¦‚ä½•ä½¿ç”¨ Electron çš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æ¨¡å—åœ¨ä¸»è¿›ç¨‹å’Œå‘ˆç°å™¨è¿›ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚

## ä»€ä¹ˆæ˜¯ preload script?

Electron çš„ä¸»è¿›ç¨‹æ˜¯ä¸€ä¸ªå¯ä»¥å®Œå…¨è®¿é—®æ“ä½œç³»ç»Ÿçš„ Node.js ç¯å¢ƒã€‚é™¤äº† Electron æ¨¡å—ï¼Œä½ è¿˜å¯ä»¥è®¿é—® Node.js å†…ç½®æ¨¡å—ï¼Œä»¥åŠé€šè¿‡ npm å®‰è£…çš„ä»»ä½•è½¯ä»¶åŒ…ã€‚å¦ä¸€æ–¹é¢ï¼Œæ¸²æŸ“å™¨è¿›ç¨‹è¿è¡Œç½‘é¡µï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸è¿è¡Œ Node.jsã€‚

ä¸ºäº†å°† Electron çš„ä¸åŒè¿›ç¨‹ç±»å‹è¿æ¥åœ¨ä¸€èµ·ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ç§å«åš**preload**çš„ç‰¹æ®Šè„šæœ¬ã€‚

## ç”¨é¢„è½½è„šæœ¬å¢å¼ºæ¸²æŸ“å™¨(Augmenting the renderer with a preload script)

BrowserWindow çš„é¢„åŠ è½½è„šæœ¬åœ¨å¯è®¿é—® HTML DOM ä»¥åŠ Node.js å’Œ Electron API æœ‰é™å­é›†çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œã€‚

> é¢„è½½è„šæœ¬æ²™ç®±
> ä» Electron 20 å¼€å§‹ï¼Œé¢„åŠ è½½è„šæœ¬é»˜è®¤å¤„äºæ²™ç›’ç¯å¢ƒä¸­ï¼Œä¸å†èƒ½å¤Ÿè®¿é—®å®Œæ•´çš„ Node.js ç¯å¢ƒã€‚å®é™…ä¸Šï¼Œè¿™æ„å‘³ç€ä½ åªèƒ½è®¿é—®æœ‰é™çš„ APIã€‚
> Available API Details
> Electron modules Renderer process modules
> Node.js modules events, timers, url
> Polyfilled globals Buffer, process, clearImmediate, setImmediate
> æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[Process Sandboxing](https://www.electronjs.org/docs/latest/tutorial/sandbox)æŒ‡å—ã€‚

é¢„åŠ è½½è„šæœ¬ä¼šåœ¨ç½‘é¡µåŠ è½½åˆ°æ¸²æŸ“å™¨ä¹‹å‰æ³¨å…¥ï¼Œç±»ä¼¼äº Chrome æµè§ˆå™¨æ‰©å±•çš„å†…å®¹è„šæœ¬ã€‚è¦åœ¨æ¸²æŸ“å™¨ä¸­æ·»åŠ éœ€è¦æƒé™è®¿é—®çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ contextBridge API å®šä¹‰å…¨å±€å¯¹è±¡ã€‚

ä¸ºäº†æ¼”ç¤ºè¿™ä¸€æ¦‚å¿µï¼Œæ‚¨å°†åˆ›å»ºä¸€ä¸ªé¢„åŠ è½½è„šæœ¬ï¼Œå°†åº”ç”¨ç¨‹åºçš„ Chromeã€Node å’Œ Electron ç‰ˆæœ¬å…¬å¼€åˆ°æ¸²æŸ“å™¨ä¸­ã€‚

æ·»åŠ æ–°çš„ preload.js è„šæœ¬ï¼Œåœ¨ç‰ˆæœ¬å…¨å±€å˜é‡ä¸­å‘æ¸²æŸ“å™¨å™¨è¿›ç¨‹å…¬å¼€ Electron çš„ process.versions å¯¹è±¡çš„é€‰å®šå±æ€§ã€‚

```javascript
const { contextBridge } = require("electron");

contextBridge.exposeInMainWorld("versions", {
    node: () => process.versions.node,
    chrome: () => process.versions.chrome,
    electron: () => process.versions.electron,
    // we can also expose variables, not just functions
});
```

è¦å°†æ­¤è„šæœ¬é™„åŠ åˆ°æ¸²æŸ“å™¨è¿›ç¨‹ï¼Œè¯·å°†å…¶è·¯å¾„ä¼ é€’åˆ° BrowserWindow æ„é€ å‡½æ•°ä¸­çš„ webPreferences.preload é€‰é¡¹ï¼š

```javascript
const { app, BrowserWindow } = require("electron");
const path = require("node:path");

const createWindow = () => {
    const win = new BrowserWindow({
        width: 800,
        height: 600,
        webPreferences: {
            preload: path.join(__dirname, "preload.js"),
        },
    });

    win.loadFile("index.html");
};

app.whenReady().then(() => {
    createWindow();
});
```

æ­¤æ—¶ï¼Œæ¸²æŸ“å™¨å¯ä»¥è®¿é—®ç‰ˆæœ¬å…¨å±€ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨çª—å£ä¸­æ˜¾ç¤ºè¯¥ä¿¡æ¯ã€‚å¯ä»¥é€šè¿‡ window.versions æˆ–ç®€å•çš„ versions è®¿é—®è¯¥å˜é‡ã€‚åˆ›å»ºä¸€ä¸ª renderer.js è„šæœ¬ï¼Œä½¿ç”¨ document.getElementById DOM API æ›¿æ¢ä»¥ info ä½œä¸º id å±æ€§çš„ HTML å…ƒç´ çš„æ˜¾ç¤ºæ–‡æœ¬ã€‚

```javascript
const information = document.getElementById("info");
information.innerText = `This app is using Chrome (v${versions.chrome()}), Node.js (v${versions.node()}), and Electron (v${versions.electron()})`;
```

ç„¶åï¼Œä¿®æ”¹ index.htmlï¼Œæ·»åŠ ä¸€ä¸ªä»¥ info ä½œä¸º id å±æ€§çš„æ–°å…ƒç´ ï¼Œå¹¶é™„åŠ  renderer.js è„šæœ¬ï¼š

```javascript
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <title>Hello from Electron renderer!</title>
  </head>
  <body>
    <h1>Hello from Electron renderer!</h1>
    <p>ğŸ‘‹</p>
    <p id="info"></p>
  </body>
  <script src="./renderer.js"></script>
</html>
```

## è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡

å¦‚ä¸Šæ‰€è¿°ï¼ŒElectron çš„ä¸»è¿›ç¨‹å’Œæ¸²æŸ“å™¨è¿›ç¨‹èŒè´£åˆ†æ˜ï¼Œä¸å¯äº’æ¢ã€‚è¿™æ„å‘³ç€æ— æ³•ç›´æ¥ä»æ¸²æŸ“å™¨è¿›ç¨‹è®¿é—® Node.js APIï¼Œä¹Ÿæ— æ³•ä»ä¸»è¿›ç¨‹è®¿é—® HTML æ–‡æ¡£å¯¹è±¡æ¨¡å‹ï¼ˆDOMï¼‰ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•æ˜¯ä½¿ç”¨ Electron çš„ ipcMain å’Œ ipcRenderer æ¨¡å—è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ã€‚è¦ä»ç½‘é¡µå‘ä¸»è¿›ç¨‹å‘é€æ¶ˆæ¯ï¼Œä½ å¯ä»¥ç”¨ ipcMain.handle è®¾ç½®ä¸€ä¸ªä¸»è¿›ç¨‹å¤„ç†ç¨‹åºï¼Œç„¶ååœ¨é¢„åŠ è½½è„šæœ¬ä¸­å…¬å¼€ä¸€ä¸ªè°ƒç”¨ ipcRenderer.invoke çš„å‡½æ•°æ¥è§¦å‘å¤„ç†ç¨‹åºã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åœ¨æ¸²æŸ“å™¨ä¸­æ·»åŠ ä¸€ä¸ªåä¸º ping() çš„å…¨å±€å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†ä»ä¸»è¿›ç¨‹è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚

é¦–å…ˆï¼Œåœ¨é¢„åŠ è½½è„šæœ¬ä¸­è®¾ç½® invoke è°ƒç”¨ï¼š

```javascript
const { contextBridge, ipcRenderer } = require("electron");

contextBridge.exposeInMainWorld("versions", {
    node: () => process.versions.node,
    chrome: () => process.versions.chrome,
    electron: () => process.versions.electron,
    ping: () => ipcRenderer.invoke("ping"),
    // we can also expose variables, not just functions
});
```

> **ipc å®‰å…¨**
> æ³¨æ„æˆ‘ä»¬æ˜¯å¦‚ä½•å°† ipcRenderer.invoke('ping') è°ƒç”¨å°è£…åœ¨ä¸€ä¸ªè¾…åŠ©å‡½æ•°ä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥é€šè¿‡ä¸Šä¸‹æ–‡æ¡¥æ¥æš´éœ² ipcRenderer æ¨¡å—çš„ã€‚ä½ æ°¸è¿œéƒ½ä¸æƒ³é€šè¿‡é¢„åŠ è½½ç›´æ¥æš´éœ²æ•´ä¸ª ipcRenderer æ¨¡å—ã€‚è¿™å°†ä½¿ä½ çš„å‘ˆç°å™¨æœ‰èƒ½åŠ›å‘ä¸»è¿›ç¨‹å‘é€ä»»æ„ IPC æ¶ˆæ¯ï¼Œä»è€Œæˆä¸ºæ¶æ„ä»£ç çš„å¼ºå¤§æ”»å‡»è½½ä½“ã€‚

ç„¶åï¼Œåœ¨ä¸»è¿›ç¨‹ä¸­è®¾ç½®å¥æŸ„ç›‘å¬å™¨ã€‚æˆ‘ä»¬è¦åœ¨åŠ è½½ HTML æ–‡ä»¶ä¹‹å‰å®Œæˆè¿™é¡¹å·¥ä½œï¼Œè¿™æ ·å°±èƒ½ä¿è¯åœ¨ä»æ¸²æŸ“å™¨å‘å‡ºè°ƒç”¨ä¹‹å‰ï¼Œå¤„ç†ç¨‹åºå·²ç»å‡†å¤‡å°±ç»ªã€‚

```javascript
const { app, BrowserWindow, ipcMain } = require("electron/main");
const path = require("node:path");

const createWindow = () => {
    const win = new BrowserWindow({
        width: 800,
        height: 600,
        webPreferences: {
            preload: path.join(__dirname, "preload.js"),
        },
    });
    win.loadFile("index.html");
};
app.whenReady().then(() => {
    ipcMain.handle("ping", () => "pong");
    createWindow();
});
```

è®¾ç½®å¥½å‘é€æ–¹å’Œæ¥æ”¶æ–¹åï¼Œå°±å¯ä»¥é€šè¿‡åˆšåˆšå®šä¹‰çš„ "ping "é€šé“ä»æ¸²æŸ“å™¨å‘ä¸»è¿›ç¨‹å‘é€ä¿¡æ¯äº†ã€‚

```javascript
const func = async () => {
    const response = await window.versions.ping();
    console.log(response); // prints out 'pong'
};

func();
```

> æœ‰å…³ä½¿ç”¨ ipcRenderer å’Œ ipcMain æ¨¡å—çš„æ›´å¤šæ·±å…¥è§£é‡Šï¼Œè¯·æŸ¥é˜…å®Œæ•´çš„[è¿›ç¨‹é—´é€šä¿¡æŒ‡å—](https://www.electronjs.org/docs/latest/tutorial/ipc)ã€‚

## æ€»ç»“

é¢„åŠ è½½è„šæœ¬åŒ…å«åœ¨ç½‘é¡µåŠ è½½åˆ°æµè§ˆå™¨çª—å£ä¹‹å‰è¿è¡Œçš„ä»£ç ã€‚å®ƒå¯ä»¥è®¿é—® DOM API å’Œ Node.js ç¯å¢ƒï¼Œé€šå¸¸ç”¨äºé€šè¿‡ contextBridge API å°†ç‰¹æƒ API æš´éœ²ç»™å‘ˆç°å™¨ã€‚

ç”±äºä¸»è¿›ç¨‹å’Œæ¸²æŸ“å™¨è¿›ç¨‹çš„èŒè´£æˆªç„¶ä¸åŒï¼ŒElectron åº”ç”¨ç¨‹åºé€šå¸¸ä½¿ç”¨é¢„åŠ è½½è„šæœ¬æ¥è®¾ç½®è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æ¥å£ï¼Œä»¥ä¾¿åœ¨è¿™ä¸¤ç§è¿›ç¨‹ä¹‹é—´ä¼ é€’ä»»æ„ä¿¡æ¯ã€‚

åœ¨æ•™ç¨‹çš„ä¸‹ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å‘æ‚¨å±•ç¤ºä¸ºåº”ç”¨ç¨‹åºæ·»åŠ æ›´å¤šåŠŸèƒ½çš„èµ„æºï¼Œç„¶åæ•™æ‚¨å‘ç”¨æˆ·åˆ†å‘åº”ç”¨ç¨‹åºã€‚
